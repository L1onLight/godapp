name: CI

on:
  push:
  pull_request:

jobs:
  build-compose:
    name: Build Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build images
        run: docker compose -f docker-compose/compose.base.yaml -f docker-compose/compose.django.yaml build

  test:
    name: Django Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: godapp_db
          POSTGRES_USER: godapp_user
          POSTGRES_PASSWORD: godapp_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U godapp_user -d godapp_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DJANGO_SETTINGS_MODULE: core.settings.local
      POSTGRES_HOST_LOCAL: localhost
      POSTGRES_PORT_LOCAL: 5432
      POSTGRES_USER: godapp_user
      POSTGRES_PASSWORD: godapp_password
      POSTGRES_DB: godapp_db
      REDIS_HOST: localhost
      REDIS_PORT: 6379
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: python -m pip install --upgrade pip poetry

      - name: Install dependencies
        working-directory: backend/godapp_main
        run: |
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-root --with dev

      - name: Wait for services
        run: sleep 10

      - name: Run migrations
        working-directory: backend/godapp_main
        run: poetry run python manage.py migrate --noinput

      - name: Run tests
        working-directory: backend/godapp_main
        run: poetry run python manage.py test
