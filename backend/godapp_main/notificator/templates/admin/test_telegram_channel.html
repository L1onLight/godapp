{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Test Telegram Channel{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<style>
    #editor-container {
        display: none;
        margin-bottom: 10px;
    }

    #id_message {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>Test Telegram Channel</h1>

    <form method="post" class="form" id="testForm">
        {% csrf_token %}

        <div class="form-row">
            <div>
                <label for="id_channel">Channel:</label>
                <select name="channel_id" id="id_channel" required>
                    <option value="">-- Select a channel --</option>
                    {% for channel in channels %}
                    <option value="{{ channel.id }}" data-method="{{ channel.parse_mode }}">{{ channel.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div>
                <label for="id_message">Test Message:</label>

                <!-- Toast UI Editor Container (hidden by default) -->
                <div id="editor-container" style="background-color: white;"></div>

                <!-- Regular textarea (shown by default) -->
                <textarea name="message" id="id_message" rows="4" placeholder="Enter test message..."
                    required></textarea>
            </div>
        </div>

        <div class="submit-row">
            <button type="submit" class="button default">Send Test Message</button>
        </div>
    </form>

    {% if result %}
    <div class="message {% if result.success %}success{% else %}error{% endif %}">
        {{ result.message }}
    </div>
    {% endif %}
</div>

<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script>
    let editor = null;
    const channelSelect = document.getElementById('id_channel');
    const messageTextarea = document.getElementById('id_message');
    const editorContainer = document.getElementById('editor-container');
    const form = document.getElementById('testForm');

    // Handle channel selection change
    channelSelect.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        const method = selectedOption.getAttribute('data-method');
        console.log('Selected method:', method);
        if (method === 'MarkdownV2' || method === 'Markdown') {
            // Show Toast UI Editor
            messageTextarea.style.display = 'none';
            messageTextarea.removeAttribute('required');
            editorContainer.style.display = 'block';

            // Initialize editor if not already created
            if (!editor) {
                editor = new toastui.Editor({
                    el: editorContainer,
                    height: '300px',
                    initialEditType: 'markdown',
                    previewStyle: 'vertical',
                    placeholder: 'Enter test message in Markdown...',
                    initialValue: messageTextarea.value || ''
                });
            } else {
                // Set existing textarea value to editor
                editor.setMarkdown(messageTextarea.value || '');
            }
        } else {
            // Show regular textarea
            editorContainer.style.display = 'none';
            messageTextarea.style.display = 'block';
            messageTextarea.setAttribute('required', 'required');

            // Sync editor content back to textarea if editor exists
            if (editor) {
                messageTextarea.value = editor.getMarkdown();
            }
        }
    });

    // Sync editor content to hidden textarea before form submission
    form.addEventListener('submit', function (event) {
        const selectedOption = channelSelect.options[channelSelect.selectedIndex];
        const method = selectedOption.getAttribute('data-method');

        if (method === 'markdown_v2' && editor) {
            messageTextarea.value = editor.getMarkdown();
        }
    });
</script>

{% endblock %}